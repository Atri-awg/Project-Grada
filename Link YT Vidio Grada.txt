import 'package:flutter/material.dart';
import 'package:firebase_core/firebase_core.dart';
import 'package:firebase_auth/firebase_auth.dart';
import 'firebase_options.dart';
import 'screens/home_screen.dart';
import 'screens/auth/login_screen.dart';

void main() async {
  WidgetsFlutterBinding.ensureInitialized();
  
  // Initialize Firebase
  await Firebase.initializeApp(
    options: DefaultFirebaseOptions.currentPlatform,
  );
  
  // CATATAN: setPersistence() hanya untuk web, tidak untuk mobile
  // Di mobile, persistence otomatis aktif
  
  runApp(const MyApp());
}

class MyApp extends StatelessWidget {
  const MyApp({super.key});

  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      title: 'Aplikasi Koreksi Ujian',
      debugShowCheckedModeBanner: false,
      theme: ThemeData(
        primarySwatch: Colors.blue,
        useMaterial3: true,
      ),
      home: const AuthWrapper(),
    );
  }
}

class AuthWrapper extends StatelessWidget {
  const AuthWrapper({super.key});

  @override
  Widget build(BuildContext context) {
    return StreamBuilder<User?>(
      stream: FirebaseAuth.instance.authStateChanges(),
      builder: (context, snapshot) {
        // Loading
        if (snapshot.connectionState == ConnectionState.waiting) {
          return Scaffold(
            body: Center(
              child: Column(
                mainAxisAlignment: MainAxisAlignment.center,
                children: const [
                  CircularProgressIndicator(),
                  SizedBox(height: 16),
                  Text('Memuat...'),
                ],
              ),
            ),
          );
        }
// File generated by FlutterFire CLI.
// ignore_for_file: type=lint
import 'package:firebase_core/firebase_core.dart' show FirebaseOptions;
import 'package:flutter/foundation.dart'
    show defaultTargetPlatform, kIsWeb, TargetPlatform;

/// Default [FirebaseOptions] for use with your Firebase apps.
///
/// Example:
/// ```dart
/// import 'firebase_options.dart';
/// // ...
/// await Firebase.initializeApp(
///   options: DefaultFirebaseOptions.currentPlatform,
/// );
/// ```
class DefaultFirebaseOptions {
  static FirebaseOptions get currentPlatform {
    if (kIsWeb) {
      return web;
    }
    switch (defaultTargetPlatform) {
      case TargetPlatform.android:
        return android;
      case TargetPlatform.iOS:
        return ios;
      case TargetPlatform.macOS:
        return macos;
      case TargetPlatform.windows:
        return windows;
      case TargetPlatform.linux:
        throw UnsupportedError(
          'DefaultFirebaseOptions have not been configured for linux - '
          'you can reconfigure this by running the FlutterFire CLI again.',
        );
      default:
        throw UnsupportedError(
          'DefaultFirebaseOptions are not supported for this platform.',
        );
    }
  }

  static const FirebaseOptions web = FirebaseOptions(
    apiKey: 'AIzaSyBYBuO655Mwz8ePhtB1kh5saqg9baNIFmw',
    appId: '1:12448289876:web:b8af538cd4d385bf2f89c1',
    messagingSenderId: '12448289876',
    projectId: 'koreksi-ujian-app',
    authDomain: 'koreksi-ujian-app.firebaseapp.com',
    storageBucket: 'koreksi-ujian-app.firebasestorage.app',
  );

  static const FirebaseOptions android = FirebaseOptions(
    apiKey: 'AIzaSyALCBfTovb5Mev7Riv83qhmnwXI-vyy2d0',
    appId: '1:12448289876:android:613ed4eaa23b98802f89c1',
    messagingSenderId: '12448289876',
    projectId: 'koreksi-ujian-app',
    storageBucket: 'koreksi-ujian-app.firebasestorage.app',
  );

  static const FirebaseOptions ios = FirebaseOptions(
    apiKey: 'AIzaSyDT07Z4X1naF-pLLa_aGCh-bB8B0h9C9Js',
    appId: '1:12448289876:ios:b10ab8780ce231312f89c1',
    messagingSenderId: '12448289876',
    projectId: 'koreksi-ujian-app',
    storageBucket: 'koreksi-ujian-app.firebasestorage.app',
    iosBundleId: 'com.example.aplikasiKoreksiUjian',
  );

  static const FirebaseOptions macos = FirebaseOptions(
    apiKey: 'AIzaSyDT07Z4X1naF-pLLa_aGCh-bB8B0h9C9Js',
    appId: '1:12448289876:ios:b10ab8780ce231312f89c1',
    messagingSenderId: '12448289876',
    projectId: 'koreksi-ujian-app',
    storageBucket: 'koreksi-ujian-app.firebasestorage.app',
    iosBundleId: 'com.example.aplikasiKoreksiUjian',
  );

  static const FirebaseOptions windows = FirebaseOptions(
    apiKey: 'AIzaSyBYBuO655Mwz8ePhtB1kh5saqg9baNIFmw',
    appId: '1:12448289876:web:5c336ee4baff92262f89c1',
    messagingSenderId: '12448289876',
    projectId: 'koreksi-ujian-app',
    authDomain: 'koreksi-ujian-app.firebaseapp.com',
    storageBucket: 'koreksi-ujian-app.firebasestorage.app',
  );
}
import 'dart:typed_data';
import 'package:pdf/pdf.dart';
import 'package:pdf/widgets.dart' as pw;
import 'package:printing/printing.dart';
import 'package:barcode/barcode.dart';

class PDFGenerator {
  Future<void> generateAndPrint({
    required String kodeSoal,
    required String namaSoal,
    required int jumlahSoal,
  }) async {
    final pdf = pw.Document();

    pdf.addPage(
      pw.Page(
        pageFormat: PdfPageFormat.a4,
        margin: const pw.EdgeInsets.all(20),
        build: (pw.Context context) {
          return pw.Stack(
            children: [
              // CORNER MARKERS - Titik hitam di 4 pojok untuk alignment
              pw.Positioned(
                top: 5,
                left: 5,
                child: _buildCornerMarker(),
              ),
              pw.Positioned(
                top: 5,
                right: 5,
                child: _buildCornerMarker(),
              ),
              pw.Positioned(
                bottom: 5,
                left: 5,
                child: _buildCornerMarker(),
              ),
              pw.Positioned(
                bottom: 5,
                right: 5,
                child: _buildCornerMarker(),
              ),

              // KONTEN UTAMA
              pw.Padding(
                padding: const pw.EdgeInsets.all(30),
                child: pw.Column(
                  crossAxisAlignment: pw.CrossAxisAlignment.start,
                  children: [
                    // HEADER
                    pw.Center(
                      child: pw.Column(
                        children: [
                          pw.Text(
                            'LEMBAR JAWABAN UJIAN',
                            style: pw.TextStyle(
                              fontSize: 20,
                              fontWeight: pw.FontWeight.bold,
                            ),
                          ),
                          pw.SizedBox(height: 5),
                          pw.Container(
                            width: 200,
                            height: 2,
                            color: PdfColors.black,
                          ),
                        ],
                      ),
                    ),
                    pw.SizedBox(height: 15),

                    // INFO SOAL
                    pw.Row(
                      mainAxisAlignment: pw.MainAxisAlignment.spaceBetween,
                      children: [
                        pw.Column(
                          crossAxisAlignment: pw.CrossAxisAlignment.start,
                          children: [
                            pw.Text(
                              'Kode Soal: $kodeSoal',
                              style: pw.TextStyle(
                                fontSize: 12,
                                fontWeight: pw.FontWeight.bold,
                              ),
                            ),
                            pw.SizedBox(height: 3),
                            pw.Text(
                              'Mata Pelajaran: $namaSoal',
                              style: const pw.TextStyle(fontSize: 11),
                            ),
                            pw.SizedBox(height: 3),
                            pw.Text(
                              'Jumlah Soal: $jumlahSoal',
                              style: const pw.TextStyle(fontSize: 11),
                            ),
                          ],
                        ),
                        // BARCODE untuk identifikasi
                        _buildBarcode(kodeSoal),
                      ],
                    ),
                    pw.SizedBox(height: 15),

                    // INFO SISWA
                    pw.Container(
                      padding: const pw.EdgeInsets.all(10),
                      decoration: pw.BoxDecoration(
                        border: pw.Border.all(width: 1.5),
                      ),
                      child: pw.Column(
                        children: [
                          pw.Row(
                            children: [
                              pw.Expanded(
                                flex: 2,
                                child: pw.Row(
                                  children: [
                                    pw.Text('Nama: ',
                                        style: const pw.TextStyle(fontSize: 11)),
                                    pw.Expanded(
                                      child: pw.Container(
                                        height: 20,
                                        decoration: const pw.BoxDecoration(
                                          border: pw.Border(
                                            bottom: pw.BorderSide(width: 1),
                                          ),
                                        ),
                                      ),
                                    ),
                                  ],
                                ),
                              ),
                              pw.SizedBox(width: 20),
                              pw.Expanded(
                                child: pw.Row(
                                  children: [
                                    pw.Text('Kelas: ',
                                        style: const pw.TextStyle(fontSize: 11)),
                                    pw.Expanded(
                                      child: pw.Container(
                                        height: 20,
                                        decoration: const pw.BoxDecoration(
                                          border: pw.Border(
                                            bottom: pw.BorderSide(width: 1),
                                          ),
                                        ),
                                      ),
                                    ),
                                  ],
                                ),
                              ),
                            ],
                          ),
                        ],
                      ),
                    ),
                    pw.SizedBox(height: 12),

                    // PETUNJUK
                    pw.Container(
                      padding: const pw.EdgeInsets.all(8),
                      decoration: pw.BoxDecoration(
                        color: PdfColors.grey300,
                        border: pw.Border.all(width: 1),
                      ),
                      child: pw.Column(
                        crossAxisAlignment: pw.CrossAxisAlignment.start,
                        children: [
                          pw.Text(
                            'PETUNJUK PENGISIAN:',
                            style: pw.TextStyle(
                              fontSize: 9,
                              fontWeight: pw.FontWeight.bold,
                            ),
                          ),
                          pw.SizedBox(height: 3),
                          pw.Text(
                            '‚Ä¢ Gunakan pensil 2B untuk menghitamkan bulatan jawaban',
                            style: const pw.TextStyle(fontSize: 8),
                          ),
                          pw.Text(
                            '‚Ä¢ Hitamkan dengan sempurna, jangan sampai keluar dari bulatan',
                            style: const pw.TextStyle(fontSize: 8),
                          ),
                          pw.Text(
                            '‚Ä¢ Jangan mencoret, melipat, atau mengotori lembar jawaban',
                            style: const pw.TextStyle(fontSize: 8),
                          ),
                          pw.Text(
                            '‚Ä¢ Pastikan 4 titik hitam di pojok tidak tertutup atau rusak',
                            style: const pw.TextStyle(fontSize: 8),
                          ),
                        ],
                      ),
                    ),
                    pw.SizedBox(height: 15),

                    // GRID JAWABAN
                    pw.Text(
                      'JAWABAN:',
                      style: pw.TextStyle(
                        fontSize: 12,
                        fontWeight: pw.FontWeight.bold,
                      ),
                    ),
                    pw.SizedBox(height: 8),

                    // Generate grid dalam 2 kolom
                    pw.Row(
                      crossAxisAlignment: pw.CrossAxisAlignment.start,
                      children: [
                        // Kolom 1
                        pw.Expanded(
                          child: _buildAnswerColumn(
                            1,
                            (jumlahSoal / 2).ceil(),
                          ),
                        ),
                        pw.SizedBox(width: 15),
                        // Kolom 2
                        pw.Expanded(
                          child: _buildAnswerColumn(
                            (jumlahSoal / 2).ceil() + 1,
                            jumlahSoal,
                          ),
                        ),
                      ],
                    ),

                    pw.Spacer(),

                    // FOOTER
                    pw.Center(
                      child: pw.Container(
                        padding: const pw.EdgeInsets.only(top: 5),
                        decoration: const pw.BoxDecoration(
                          border: pw.Border(
                            top: pw.BorderSide(width: 1),
                          ),
                        ),
                        child: pw.Text(
                          'Scan lembar jawaban menggunakan aplikasi untuk penilaian otomatis',
                          style: pw.TextStyle(
                            fontSize: 8,
                            color: PdfColors.grey700,
                            fontStyle: pw.FontStyle.italic,
                          ),
                        ),
                      ),
                    ),
                  ],
                ),
              ),
            ],
          );
        },
      ),
    );

    // Print PDF
    await Printing.layoutPdf(
      onLayout: (PdfPageFormat format) async => pdf.save(),
    );
  }

  // Titik marker hitam di pojok untuk deteksi kamera
  pw.Widget _buildCornerMarker() {
    return pw.Container(
      width: 15,
      height: 15,
      decoration: const pw.BoxDecoration(
        color: PdfColors.black,
        shape: pw.BoxShape.circle,
      ),
    );
  }

  // Widget QR Code untuk kode soal
  pw.Widget _buildBarcode(String kodeSoal) {
    return pw.Container(
      width: 70,
      height: 70,
      child: pw.Column(
        children: [
          pw.Expanded(
            child: pw.BarcodeWidget(
              data: kodeSoal,
              barcode: Barcode.qrCode(),
              drawText: false,
            ),
          ),
          pw.SizedBox(height: 2),
          pw.Text(
            kodeSoal,
            style: pw.TextStyle(
              fontSize: 8,
              fontWeight: pw.FontWeight.bold,
            ),
          ),
        ],
      ),
    );
  }

  // Kolom jawaban dengan bubble A-E
  pw.Widget _buildAnswerColumn(int start, int end) {
    final options = ['A', 'B', 'C', 'D', 'E'];

    return pw.Column(
      children: List.generate(end - start + 1, (index) {
        final nomor = start + index;
        return pw.Padding(
          padding: const pw.EdgeInsets.only(bottom: 6),
          child: pw.Row(
            children: [
              // Nomor soal
              pw.Container(
                width: 25,
                child: pw.Text(
                  '$nomor.',
                  style: pw.TextStyle(
                    fontSize: 10,
                    fontWeight: pw.FontWeight.bold,
                  ),
                ),
              ),
              // Opsi A-E dengan bubble
              pw.Expanded(
                child: pw.Row(
                  mainAxisAlignment: pw.MainAxisAlignment.spaceEvenly,
                  children: options.map((option) {
                    return pw.Column(
                      children: [
                        pw.Text(
                          option,
                          style: const pw.TextStyle(fontSize: 8),
                        ),
                        pw.SizedBox(height: 2),
                        pw.Container(
                          width: 12,
                          height: 12,
                          decoration: pw.BoxDecoration(
                            shape: pw.BoxShape.circle,
                            border: pw.Border.all(width: 1.5),
                          ),
                        ),
                      ],
                    );
                  }).toList(),
                ),
              ),
            ],
          ),
        );
      }),
    );
  }
}import 'package:image/image.dart' as img;

class OMRProcessor {
  
  // Fungsi Utama Proses LJK
  Future<Map<String, dynamic>> prosesLJK(
    img.Image image, 
    List<String> kunciJawaban,
    int jumlahSoal,
  ) async {
    
    // 1. DETEKSI 4 MARKER POINTS (pojok kertas)
    List<Point>? markers = _detectMarkers(image);
    if (markers == null || markers.length != 4) {
      throw Exception("Tidak dapat mendeteksi 4 marker pojok kertas");
    }

    // 2. PERSPECTIVE CORRECTION (luruskan kertas)
    img.Image correctedImage = _perspectiveTransform(image, markers);

    // 3. DETEKSI JAWABAN SISWA
    List<String> jawabanSiswa = _detectAnswers(correctedImage, jumlahSoal);

    // 4. KOREKSI
    return _koreksi(jawabanSiswa, kunciJawaban);
  }

  // --- STEP 1: DETEKSI 4 MARKER POJOK ---
  List<Point>? _detectMarkers(img.Image image) {
    // Convert ke grayscale
    img.Image gray = img.grayscale(image);
    
    // Threshold untuk deteksi hitam
    img.Image binary = img.Image(width: gray.width, height: gray.height);
    for (int y = 0; y < gray.height; y++) {
      for (int x = 0; x < gray.width; x++) {
        var pixel = gray.getPixel(x, y);
        int brightness = pixel.r.toInt();
        int colorValue = brightness < 100 ? 0 : 255;
        // setPixelRgba sekarang butuh 6 parameter: x, y, r, g, b, a
        binary.setPixelRgba(x, y, colorValue, colorValue, colorValue, 255);
      }
    }

    // Cari 4 titik hitam terbesar di pojok
    List<Point> candidates = [];
    
    // Scan area pojok (dibagi jadi 4 kuadran)
    int w = binary.width;
    int h = binary.height;
    
    // Kiri Atas
    candidates.add(_findDarkestPoint(binary, 0, 0, w ~/ 3, h ~/ 3));
    // Kanan Atas
    candidates.add(_findDarkestPoint(binary, w * 2 ~/ 3, 0, w, h ~/ 3));
    // Kiri Bawah
    candidates.add(_findDarkestPoint(binary, 0, h * 2 ~/ 3, w ~/ 3, h));
    // Kanan Bawah
    candidates.add(_findDarkestPoint(binary, w * 2 ~/ 3, h * 2 ~/ 3, w, h));

    return candidates;
  }

  Point _findDarkestPoint(img.Image image, int x1, int y1, int x2, int y2) {
    int darkestX = x1;
    int darkestY = y1;
    int minBrightness = 255;

    for (int y = y1; y < y2; y++) {
      for (int x = x1; x < x2; x++) {
        var pixel = image.getPixel(x, y);
        int brightness = pixel.r.toInt();
        if (brightness < minBrightness) {
          minBrightness = brightness;
          darkestX = x;
          darkestY = y;
        }
      }
    }
    return Point(darkestX.toDouble(), darkestY.toDouble());
  }

  // --- STEP 2: PERSPECTIVE TRANSFORM (Luruskan) ---
  img.Image _perspectiveTransform(img.Image image, List<Point> markers) {
    // Urutkan marker: [TopLeft, TopRight, BottomLeft, BottomRight]
    markers.sort((a, b) {
      if ((a.y - b.y).abs() < 50) {
        return a.x.compareTo(b.x);
      }
      return a.y.compareTo(b.y);
    });

    Point topLeft = markers[0];
    Point topRight = markers[1];
    Point bottomLeft = markers[2];
    Point bottomRight = markers[3];

    // Transform sederhana (bisa pakai library opencv_dart untuk lebih akurat)
    // Untuk MVP, kita crop saja berdasarkan bounding box marker
    int minX = [topLeft.x, topRight.x, bottomLeft.x, bottomRight.x].reduce((a, b) => a < b ? a : b).toInt();
    int maxX = [topLeft.x, topRight.x, bottomLeft.x, bottomRight.x].reduce((a, b) => a > b ? a : b).toInt();
    int minY = [topLeft.y, topRight.y, bottomLeft.y, bottomRight.y].reduce((a, b) => a < b ? a : b).toInt();
    int maxY = [topLeft.y, topRight.y, bottomLeft.y, bottomRight.y].reduce((a, b) => a > b ? a : b).toInt();

    return img.copyCrop(image, 
      x: minX, 
      y: minY, 
      width: maxX - minX, 
      height: maxY - minY
    );
  }

  // --- STEP 3: DETEKSI JAWABAN ---
  List<String> _detectAnswers(img.Image image, int jumlahSoal) {
    List<String> hasil = [];
    
    // Convert ke grayscale
    img.Image gray = img.grayscale(image);
    
    // Asumsi layout: 2 kolom, 5 opsi (A-E)
    int soalPerKolom = (jumlahSoal / 2).ceil();
    double startY = image.height * 0.3; // Skip header (30%)
    double endY = image.height * 0.9;
    double rowHeight = (endY - startY) / soalPerKolom;
    
    // Kolom 1 (kiri)
    double col1X = image.width * 0.15;
    // Kolom 2 (kanan)
    double col2X = image.width * 0.65;
    
    double opsiWidth = image.width * 0.05; // Jarak antar opsi
    
    for (int i = 0; i < jumlahSoal; i++) {
      int kolom = i < soalPerKolom ? 0 : 1;
      int row = i < soalPerKolom ? i : i - soalPerKolom;
      
      double baseX = kolom == 0 ? col1X : col2X;
      double baseY = startY + (row * rowHeight);
      
      // Check setiap opsi A-E
      List<int> brightness = [];
      for (int opt = 0; opt < 5; opt++) {
        int checkX = (baseX + (opt * opsiWidth)).toInt();
        int checkY = baseY.toInt();
        
        // Sample area bulatan (15x15 pixel)
        int totalBrightness = 0;
        int count = 0;
        for (int dy = -7; dy <= 7; dy++) {
          for (int dx = -7; dx <= 7; dx++) {
            int px = checkX + dx;
            int py = checkY + dy;
            if (px >= 0 && px < gray.width && py >= 0 && py < gray.height) {
              var pixel = gray.getPixel(px, py);
              totalBrightness += pixel.r.toInt();
              count++;
            }
          }
        }
        brightness.add(totalBrightness ~/ count);
      }
      
      // Cari yang paling gelap (dihitamkan)
      int minIndex = 0;
      int minValue = brightness[0];
      for (int j = 1; j < brightness.length; j++) {
        if (brightness[j] < minValue) {
          minValue = brightness[j];
          minIndex = j;
        }
      }
      
      // Threshold: jika brightness < 150, berarti dihitamkan
      if (minValue < 150) {
        hasil.add(['A', 'B', 'C', 'D', 'E'][minIndex]);
      } else {
        hasil.add(''); // Tidak dijawab
      }
    }
    
    return hasil;
  }

  // --- STEP 4: KOREKSI ---
  Map<String, dynamic> _koreksi(List<String> jawabanSiswa, List<String> kunciJawaban) {
    int benar = 0;
    int salah = 0;
    List<Map<String, dynamic>> detail = [];

    for (int i = 0; i < kunciJawaban.length; i++) {
      String kunci = kunciJawaban[i];
      String jawaban = i < jawabanSiswa.length ? jawabanSiswa[i] : '';
      bool isBenar = jawaban == kunci;
      
      if (isBenar) benar++;
      if (!isBenar && jawaban.isNotEmpty) salah++;

      detail.add({
        'nomor': i + 1,
        'kunci': kunci,
        'jawaban': jawaban.isEmpty ? 'Kosong' : jawaban,
        'benar': isBenar,
      });
    }

    return {
      'benar': benar,
      'salah': salah,
      'total': kunciJawaban.length,
      'detail': detail,
    };
  }
}

// Helper class untuk koordinat
class Point {
  final double x;
  final double y;
  Point(this.x, this.y);
}import 'package:firebase_database/firebase_database.dart';
import 'package:firebase_core/firebase_core.dart';
import 'package:firebase_auth/firebase_auth.dart';

class MigrationHelper {
  static const String databaseURL = 'https://koreksi-ujian-app-default-rtdb.asia-southeast1.firebasedatabase.app';
  
  final DatabaseReference _db = FirebaseDatabase.instanceFor(
    app: Firebase.app(),
    databaseURL: databaseURL,
  ).ref();

  // Fungsi untuk migrasi data lama ke struktur baru
  Future<bool> migrateOldDataToUser() async {
    try {
      final userId = FirebaseAuth.instance.currentUser?.uid;
      if (userId == null) {
        print('Error: User tidak login');
        return false;
      }

      print('Memulai migrasi data...');

      // 1. Cek apakah ada data lama di root 'soal'
      final oldSoalSnapshot = await _db.child('soal').get();
      
      if (oldSoalSnapshot.exists && oldSoalSnapshot.value != null) {
        final oldData = oldSoalSnapshot.value;
        
        if (oldData is Map) {
          print('Ditemukan ${oldData.length} soal lama');
          
          // Copy data ke struktur baru
          for (var entry in oldData.entries) {
            final kodeSoal = entry.key.toString();
            final value = entry.value;
            
            if (value is Map) {
              print('Migrasi soal: $kodeSoal');
              
              // Ambil kunci jawaban dengan safe handling
              List<String> kunciJawaban = [];
              if (value['kunci_jawaban'] != null) {
                if (value['kunci_jawaban'] is List) {
                  kunciJawaban = List<String>.from(
                    (value['kunci_jawaban'] as List).map((e) => e.toString())
                  );
                }
              }
              
              // Simpan ke struktur baru
              await _db
                  .child('users')
                  .child(userId)
                  .child('soal')
                  .child(kodeSoal)
                  .set({
                'nama_soal': value['nama_soal']?.toString() ?? 'Tanpa Nama',
                'jumlah_soal': value['jumlah_soal'] ?? kunciJawaban.length,
                'kunci_jawaban': kunciJawaban,
                'tanggal_dibuat': value['tanggal_dibuat']?.toString() ?? DateTime.now().toIso8601String(),
              });
            }
          }
          
          print('Migrasi selesai!');
        }
      } else {
        print('Tidak ada data lama yang perlu dimigrasi');
      }
      
      return true;
    } catch (e) {
      print('Error migrasi: $e');
      return false;
    }
  }

  // Fungsi untuk membersihkan data lama (HATI-HATI!)
  Future<bool> cleanOldData() async {
    try {
      print('Membersihkan data lama...');
      
      // Hapus data lama di root 'soal'
      await _db.child('soal').remove();
      
      print('Data lama berhasil dihapus');
      return true;
    } catch (e) {
      print('Error hapus data lama: $e');
      return false;
    }
  }

  // Fungsi untuk cek struktur data
  Future<void> checkDataStructure() async {
    try {
      final userId = FirebaseAuth.instance.currentUser?.uid;
      if (userId == null) {
        print('User tidak login');
        return;
      }

      print('\n=== CEK STRUKTUR DATA ===');
      
      // Cek data lama
      final oldSnapshot = await _db.child('soal').get();
      if (oldSnapshot.exists) {
        print('‚ùå Data lama ditemukan di root/soal');
      } else {
        print('‚úÖ Tidak ada data lama di root/soal');
      }
      
      // Cek data baru
      final newSnapshot = await _db.child('users').child(userId).child('soal').get();
      if (newSnapshot.exists && newSnapshot.value != null) {
        final data = newSnapshot.value;
        if (data is Map) {
          print('‚úÖ Data baru ditemukan: ${data.length} soal');
        }
      } else {
        print('‚ÑπÔ∏è  Belum ada data di users/$userId/soal');
      }
      
      print('=========================\n');
    } catch (e) {
      print('Error cek struktur: $e');
    }
  }
}import 'package:firebase_database/firebase_database.dart';
import 'package:firebase_core/firebase_core.dart';
import 'package:firebase_auth/firebase_auth.dart';

class FirebaseService {
  // Database URL Anda
  static const String databaseURL = 'https://koreksi-ujian-app-default-rtdb.asia-southeast1.firebasedatabase.app';
  
  // Gunakan default Firebase instance
  final DatabaseReference _db = FirebaseDatabase.instanceFor(
    app: Firebase.app(),
    databaseURL: databaseURL,
  ).ref();

  // Fungsi helper untuk mendapatkan user ID
  String? _getUserId() {
    final user = FirebaseAuth.instance.currentUser;
    return user?.uid;
  }

  // 1. SIMPAN KUNCI JAWABAN BARU (per user)
  Future<bool> simpanKunciJawaban({
    required String kodeSoal,
    required String namaSoal,
    required List<String> kunciJawaban,
  }) async {
    try {
      final userId = _getUserId();
      if (userId == null) {
        print('Error: User tidak login');
        return false;
      }

      // Simpan di path: users/{userId}/soal/{kodeSoal}
      await _db.child('users').child(userId).child('soal').child(kodeSoal).set({
        'nama_soal': namaSoal,
        'jumlah_soal': kunciJawaban.length,
        'kunci_jawaban': kunciJawaban,
        'tanggal_dibuat': DateTime.now().toIso8601String(),
      });
      return true;
    } catch (e) {
      print('Error simpan kunci: $e');
      return false;
    }
  }

  // 2. AMBIL KUNCI JAWABAN BERDASARKAN KODE QR (per user)
  Future<Map<String, dynamic>?> cekKodeSoal(String kodeSoal) async {
    try {
      final userId = _getUserId();
      if (userId == null) {
        print('Error: User tidak login');
        return null;
      }

      final snapshot = await _db
          .child('users')
          .child(userId)
          .child('soal')
          .child(kodeSoal)
          .get();
      
      if (snapshot.exists && snapshot.value != null) {
        final data = snapshot.value;
        
        if (data is Map) {
          // Ambil kunci_jawaban dengan safe handling
          List<String> kunciJawaban = [];
          if (data['kunci_jawaban'] != null) {
            if (data['kunci_jawaban'] is List) {
              kunciJawaban = List<String>.from(
                (data['kunci_jawaban'] as List).map((e) => e.toString())
              );
            }
          }
          
          return {
            'kode_soal': kodeSoal,
            'nama_soal': data['nama_soal']?.toString() ?? 'Tanpa Nama',
            'jumlah_soal': data['jumlah_soal'] ?? kunciJawaban.length,
            'kunci_jawaban': kunciJawaban,
          };
        }
      }
      return null;
    } catch (e) {
      print('Error cek kode: $e');
      return null;
    }
  }

  // 3. AMBIL SEMUA SOAL (untuk halaman daftar soal per user)
  Future<List<Map<String, dynamic>>> getAllSoal() async {
    try {
      final userId = _getUserId();
      if (userId == null) {
        print('Error: User tidak login');
        return [];
      }

      final snapshot = await _db
          .child('users')
          .child(userId)
          .child('soal')
          .get();
      
      if (snapshot.exists && snapshot.value != null) {
        final data = snapshot.value;
        
        // Handle jika data adalah Map
        if (data is Map) {
          List<Map<String, dynamic>> listSoal = [];
          
          data.forEach((key, value) {
            if (value is Map) {
              listSoal.add({
                'kode_soal': key.toString(),
                'nama_soal': value['nama_soal']?.toString() ?? 'Tanpa Nama',
                'jumlah_soal': value['jumlah_soal'] ?? 0,
                'tanggal_dibuat': value['tanggal_dibuat']?.toString() ?? DateTime.now().toIso8601String(),
              });
            }
          });
          
          // Urutkan berdasarkan tanggal terbaru
          listSoal.sort((a, b) {
            try {
              final dateA = DateTime.parse(a['tanggal_dibuat']);
              final dateB = DateTime.parse(b['tanggal_dibuat']);
              return dateB.compareTo(dateA);
            } catch (e) {
              return 0;
            }
          });
          
          return listSoal;
        }
      }
      return [];
    } catch (e) {
      print('Error get all soal: $e');
      return [];
    }
  }

  // 4. HAPUS SOAL (per user)
  Future<bool> hapusSoal(String kodeSoal) async {
    try {
      final userId = _getUserId();
      if (userId == null) {
        print('Error: User tidak login');
        return false;
      }

      await _db
          .child('users')
          .child(userId)
          .child('soal')
          .child(kodeSoal)
          .remove();
      return true;
    } catch (e) {
      print('Error hapus soal: $e');
      return false;
    }
  }

  // 5. SIMPAN HASIL KOREKSI (per user)
  Future<bool> simpanHasilKoreksi({
    required String kodeSoal,
    required String namaLJK,
    required List<String> jawabanSiswa,
    required int skor,
    required int jumlahBenar,
    required int jumlahSalah,
  }) async {
    try {
      final userId = _getUserId();
      if (userId == null) {
        print('Error: User tidak login');
        return false;
      }

      final hasilId = DateTime.now().millisecondsSinceEpoch.toString();
      
      await _db
          .child('users')
          .child(userId)
          .child('hasil_koreksi')
          .child(hasilId)
          .set({
        'kode_soal': kodeSoal,
        'nama_ljk': namaLJK,
        'jawaban_siswa': jawabanSiswa,
        'skor': skor,
        'jumlah_benar': jumlahBenar,
        'jumlah_salah': jumlahSalah,
        'tanggal_koreksi': DateTime.now().toIso8601String(),
      });
      
      return true;
    } catch (e) {
      print('Error simpan hasil: $e');
      return false;
    }
  }

  // 6. AMBIL SEMUA HASIL KOREKSI (per user)
  Future<List<Map<String, dynamic>>> getAllHasilKoreksi() async {
    try {
      final userId = _getUserId();
      if (userId == null) {
        print('Error: User tidak login');
        return [];
      }

      final snapshot = await _db
          .child('users')
          .child(userId)
          .child('hasil_koreksi')
          .get();
      
      if (snapshot.exists && snapshot.value != null) {
        final data = snapshot.value;
        
        if (data is Map) {
          List<Map<String, dynamic>> listHasil = [];
          
          data.forEach((key, value) {
            if (value is Map) {
              listHasil.add({
                'id': key.toString(),
                'kode_soal': value['kode_soal']?.toString() ?? '',
                'nama_ljk': value['nama_ljk']?.toString() ?? 'Tanpa Nama',
                'skor': value['skor'] ?? 0,
                'jumlah_benar': value['jumlah_benar'] ?? 0,
                'jumlah_salah': value['jumlah_salah'] ?? 0,
                'tanggal_koreksi': value['tanggal_koreksi']?.toString() ?? DateTime.now().toIso8601String(),
              });
            }
          });
          
          // Urutkan berdasarkan tanggal terbaru
          listHasil.sort((a, b) {
            try {
              final dateA = DateTime.parse(a['tanggal_koreksi']);
              final dateB = DateTime.parse(b['tanggal_koreksi']);
              return dateB.compareTo(dateA);
            } catch (e) {
              return 0;
            }
          });
          
          return listHasil;
        }
      }
      return [];
    } catch (e) {
      print('Error get hasil koreksi: $e');
      return [];
    }
  }
}import 'package:firebase_auth/firebase_auth.dart';
import 'package:cloud_firestore/cloud_firestore.dart';

class AuthService {
  final FirebaseAuth _auth = FirebaseAuth.instance;
  final FirebaseFirestore _firestore = FirebaseFirestore.instance;

  User? get currentUser => _auth.currentUser;
  Stream<User?> get authStateChanges => _auth.authStateChanges();
  String? get currentUserId => _auth.currentUser?.uid;

  Future<UserCredential?> registerWithEmailPassword({
    required String email,
    required String password,
    required String name,
  }) async {
    try {
      UserCredential userCredential = await _auth.createUserWithEmailAndPassword(
        email: email,
        password: password,
      );

      await userCredential.user?.updateDisplayName(name);

      await _firestore.collection('users').doc(userCredential.user!.uid).set({
        'uid': userCredential.user!.uid,
        'email': email,
        'name': name,
        'createdAt': FieldValue.serverTimestamp(),
      });

      return userCredential;
    } on FirebaseAuthException catch (e) {
      throw _handleAuthException(e);
    }
  }

  Future<UserCredential?> signInWithEmailPassword({
    required String email,
    required String password,
  }) async {
    try {
      // KUNCI UTAMA: Sign out dulu jika ada user untuk clear cache
      final currentUser = _auth.currentUser;
      if (currentUser != null) {
        print('‚ö†Ô∏è User masih login, sign out dulu...');
        await _auth.signOut();
        // Delay untuk memastikan sign out selesai
        await Future.delayed(Duration(milliseconds: 500));
      }
      
      print('üîê Melakukan login...');
      UserCredential userCredential = await _auth.signInWithEmailAndPassword(
        email: email,
        password: password,
      );
      
      print('‚úÖ Login berhasil: ${userCredential.user?.email}');
      return userCredential;
      
    } on FirebaseAuthException catch (e) {
      print('‚ùå Firebase Auth Error: ${e.code}');
      throw _handleAuthException(e);
    } catch (e) {
      print('‚ùå Unexpected Error: $e');
      // Jika error bukan FirebaseAuthException, coba force sign out dan retry
      if (e.toString().contains('PigeonUserDetails') || 
          e.toString().contains('type') ||
          e.toString().contains('cast')) {
        print('üîÑ Cache error detected, clearing and retrying...');
        try {
          await _auth.signOut();
          await Future.delayed(Duration(seconds: 1));
          
          // Retry login
          UserCredential userCredential = await _auth.signInWithEmailAndPassword(
            email: email,
            password: password,
          );
          print('‚úÖ Login retry berhasil');
          return userCredential;
        } catch (retryError) {
          print('‚ùå Retry gagal: $retryError');
          throw 'Login gagal. Silakan coba lagi.';
        }
      }
      rethrow;
    }
  }

  Future<void> signOut() async {
    try {
      print('üö™ Melakukan logout...');
      await _auth.signOut();
      // Delay untuk memastikan logout complete
      await Future.delayed(Duration(milliseconds: 500));
      print('‚úÖ Logout berhasil');
    } catch (e) {
      print('‚ùå Error logout: $e');
      // Force sign out
      try {
        await _auth.signOut();
      } catch (_) {}
    }
  }

  Future<void> resetPassword(String email) async {
    try {
      await _auth.sendPasswordResetEmail(email: email);
    } on FirebaseAuthException catch (e) {
      throw _handleAuthException(e);
    }
  }

  String _handleAuthException(FirebaseAuthException e) {
    switch (e.code) {
      case 'weak-password':
        return 'Password terlalu lemah. Minimal 6 karakter.';
      case 'email-already-in-use':
        return 'Email sudah digunakan. Silakan login atau gunakan email lain.';
      case 'invalid-email':
        return 'Format email tidak valid.';
      case 'user-not-found':
        return 'Akun tidak ditemukan. Silakan daftar terlebih dahulu.';
      case 'wrong-password':
        return 'Password salah. Silakan coba lagi.';
      case 'invalid-credential':
        return 'Email atau password salah.';
      case 'too-many-requests':
        return 'Terlalu banyak percobaan. Silakan coba lagi nanti.';
      case 'user-disabled':
        return 'Akun ini telah dinonaktifkan.';
      case 'operation-not-allowed':
        return 'Operasi tidak diizinkan.';
      default:
        return 'Terjadi kesalahan: ${e.message}';
    }
  }

  CollectionReference getUserCollection(String collectionName) {
    if (currentUserId == null) {
      throw Exception('User belum login');
    }
    return _firestore
        .collection('users')
        .doc(currentUserId)
        .collection(collectionName);
  }
}import 'dart:io';
import 'dart:async';
import 'package:flutter/material.dart';
import 'package:mobile_scanner/mobile_scanner.dart';
import 'package:camera/camera.dart';
import 'package:image/image.dart' as img;
import '../services/firebase_service.dart';
import 'result_screen.dart';

class ScannerPage extends StatefulWidget {
  const ScannerPage({super.key});

  @override
  State<ScannerPage> createState() => _ScannerPageState();
}

class _ScannerPageState extends State<ScannerPage> {
  MobileScannerController qrController = MobileScannerController();
  bool _isProcessing = false;
  String? _detectedCode;
  Map<String, dynamic>? _dataSoal;

  void _onQRDetected(String code) async {
    if (_isProcessing || _detectedCode == code) return;
    
    setState(() {
      _isProcessing = true;
      _detectedCode = code;
    });
    
    await qrController.stop();

    var dataSoal = await FirebaseService().cekKodeSoal(code);

    if (dataSoal != null) {
      _dataSoal = dataSoal;
      if (mounted) _showInstructions();
    } else {
      _showError("Kode Soal tidak ditemukan!");
    }
  }

  Future<void> _showInstructions() async {
    bool? proceed = await showDialog<bool>(
      context: context,
      barrierDismissible: false,
      builder: (context) => AlertDialog(
        title: const Row(
          children: [
            Icon(Icons.camera_alt, color: Colors.blue),
            SizedBox(width: 8),
            Text('üì∏ Petunjuk Foto LJK'),
          ],
        ),
        content: Column(
          mainAxisSize: MainAxisSize.min,
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            const Text(
              'Pastikan saat mengambil foto:',
              style: TextStyle(fontWeight: FontWeight.bold),
            ),
            const SizedBox(height: 12),
            _buildInstructionRow('‚úì', '4 titik hitam pojok terlihat semua'),
            _buildInstructionRow('‚úì', 'Foto dari atas (tegak lurus)'),
            _buildInstructionRow('‚úì', 'Pencahayaan cukup, tidak ada bayangan'),
            _buildInstructionRow('‚úì', 'Seluruh lembar masuk frame'),
            const SizedBox(height: 12),
            Container(
              padding: const EdgeInsets.all(12),
              decoration: BoxDecoration(
                color: Colors.green.shade50,
                borderRadius: BorderRadius.circular(8),
                border: Border.all(color: Colors.green, width: 2),
              ),
              child: Row(
                children: [
                  const Icon(Icons.photo_camera, color: Colors.green, size: 40),
                  const SizedBox(width: 12),
                  Expanded(
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        const Text(
                          'Posisikan kertas dalam zona hijau',
                          style: TextStyle(
                            fontSize: 13,
                            fontWeight: FontWeight.bold,
                            color: Colors.green,
                          ),
                        ),
                        const SizedBox(height: 4),
                        Text(
                          'Kamera akan otomatis mendeteksi',
                          style: TextStyle(
                            fontSize: 12,
                            color: Colors.green.shade700,
                          ),
                        ),
                      ],
                    ),
                  ),
                ],
              ),
            ),
          ],
        ),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context, false),
            child: const Text('Batal'),
          ),
          ElevatedButton(
            onPressed: () => Navigator.pop(context, true),
            style: ElevatedButton.styleFrom(
              backgroundColor: Colors.blue,
              foregroundColor: Colors.white,
              padding: const EdgeInsets.symmetric(horizontal: 24, vertical: 12),
            ),
            child: const Text('Mulai Scan'),
          ),
        ],
      ),
    );

    if (proceed == true) {
      _openCameraWithOverlay();
    } else {
      setState(() {
        _isProcessing = false;
        _detectedCode = null;
      });
      if (mounted) {
        await qrController.start();
      }
    }
  }

  Future<void> _openCameraWithOverlay() async {
    final cameras = await availableCameras();
    if (cameras.isEmpty) {
      _showError("Kamera tidak tersedia");
      return;
    }

    if (!mounted) return;

    final result = await Navigator.push(
      context,
      MaterialPageRoute(
        builder: (context) => AutoScannerScreen(
          camera: cameras.first,
          dataSoal: _dataSoal!,
        ),
      ),
    );

    if (result == true) {
      // Sukses scan, kembali ke home
      if (mounted) {
        setState(() {
          _isProcessing = false;
          _detectedCode = null;
          _dataSoal = null;
        });
      }
    } else {
      setState(() {
        _isProcessing = false;
        _detectedCode = null;
      });
      if (mounted) await qrController.start();
    }
  }

  Widget _buildInstructionRow(String icon, String text) {
    return Padding(
      padding: const EdgeInsets.only(bottom: 6),
      child: Row(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Text(
            icon,
            style: const TextStyle(color: Colors.green, fontWeight: FontWeight.bold),
          ),
          const SizedBox(width: 8),
          Expanded(child: Text(text, style: const TextStyle(fontSize: 13))),
        ],
      ),
    );
  }

  void _showError(String msg) {
    if (!mounted) return;
    
    showDialog(
      context: context,
      builder: (context) => AlertDialog(
        title: const Row(
          children: [
            Icon(Icons.error_outline, color: Colors.red),
            SizedBox(width: 8),
            Text('Error'),
          ],
        ),
        content: Text(msg),
        actions: [
          ElevatedButton(
            onPressed: () => Navigator.pop(context),
            child: const Text('OK'),
          ),
        ],
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: const Text("Scan QR Code Soal"),
        backgroundColor: Colors.blue,
        centerTitle: true,
      ),
      body: Stack(
        children: [
          MobileScanner(
            controller: qrController,
            onDetect: (capture) {
              if (_isProcessing) return;
              final List<Barcode> barcodes = capture.barcodes;
              for (final barcode in barcodes) {
                if (barcode.rawValue != null) {
                  _onQRDetected(barcode.rawValue!);
                  break;
                }
              }
            },
          ),
          
          Center(
            child: Container(
              width: 250,
              height: 250,
              decoration: BoxDecoration(
                border: Border.all(color: Colors.green, width: 3),
                borderRadius: BorderRadius.circular(10),
              ),
              child: const Center(
                child: Text(
                  "Arahkan ke QR Code",
                  style: TextStyle(
                    color: Colors.white,
                    backgroundColor: Colors.black54,
                    fontSize: 16,
                    fontWeight: FontWeight.bold,
                  ),
                  textAlign: TextAlign.center,
                ),
              ),
            ),
          ),
          
          if (_isProcessing)
            Container(
              color: Colors.black54,
              child: const Center(
                child: Column(
                  mainAxisSize: MainAxisSize.min,
                  children: [
                    CircularProgressIndicator(color: Colors.white),
                    SizedBox(height: 16),
                    Text(
                      'Memproses...',
                      style: TextStyle(color: Colors.white, fontSize: 16),
                    ),
                  ],
                ),
              ),
            ),
        ],
      ),
    );
  }

  @override
  void dispose() {
    qrController.dispose();
    super.dispose();
  }
}

// Screen auto scanner dengan deteksi otomatis
class AutoScannerScreen extends StatefulWidget {
  final CameraDescription camera;
  final Map<String, dynamic> dataSoal;

  const AutoScannerScreen({
    super.key,
    required this.camera,
    required this.dataSoal,
  });

  @override
  State<AutoScannerScreen> createState() => _AutoScannerScreenState();
}

class _AutoScannerScreenState extends State<AutoScannerScreen> {
  late CameraController _controller;
  late Future<void> _initializeControllerFuture;
  Timer? _detectionTimer;
  bool _isProcessing = false;
  bool _cornersDetected = false;
  int _detectionCount = 0;

  @override
  void initState() {
    super.initState();
    _controller = CameraController(
      widget.camera,
      ResolutionPreset.high,
    );
    _initializeControllerFuture = _controller.initialize().then((_) {
      _startAutoDetection();
    });
  }

  void _startAutoDetection() {
    _detectionTimer = Timer.periodic(const Duration(milliseconds: 500), (timer) {
      if (!_isProcessing && mounted) {
        _checkCorners();
      }
    });
  }

  Future<void> _checkCorners() async {
    if (_isProcessing) return;

    try {
      final image = await _controller.takePicture();
      final bool detected = await _detectCorners(image.path);

      if (mounted) {
        setState(() {
          _cornersDetected = detected;
        });

        if (detected) {
          _detectionCount++;
          if (_detectionCount >= 2) {
            // Deteksi stabil selama 2 kali berturut-turut
            _detectionTimer?.cancel();
            await _processImage(image.path);
          }
        } else {
          _detectionCount = 0;
        }
      }

      // Hapus file sementara jika tidak terdeteksi
      if (!detected) {
        await File(image.path).delete();
      }
    } catch (e) {
      debugPrint('Error checking corners: $e');
    }
  }

  Future<bool> _detectCorners(String imagePath) async {
    try {
      final bytes = await File(imagePath).readAsBytes();
      img.Image? image = img.decodeImage(bytes);
      
      if (image == null) return false;

      img.Image gray = img.grayscale(image);
      img.Image binary = img.Image(width: gray.width, height: gray.height);
      
      for (int y = 0; y < gray.height; y++) {
        for (int x = 0; x < gray.width; x++) {
          var pixel = gray.getPixel(x, y);
          int r = pixel.r.toInt();
          
          if (r < 50) {
            binary.setPixelRgba(x, y, 0, 0, 0, 255);
          } else {
            binary.setPixelRgba(x, y, 255, 255, 255, 255);
          }
        }
      }

      int cornerSize = (image.width * 0.15).toInt();
      
      bool topLeft = _hasBlackBlob(binary, 0, 0, cornerSize, cornerSize);
      bool topRight = _hasBlackBlob(binary, image.width - cornerSize, 0, cornerSize, cornerSize);
      bool bottomLeft = _hasBlackBlob(binary, 0, image.height - cornerSize, cornerSize, cornerSize);
      bool bottomRight = _hasBlackBlob(binary, image.width - cornerSize, image.height - cornerSize, cornerSize, cornerSize);

      return topLeft && topRight && bottomLeft && bottomRight;
      
    } catch (e) {
      debugPrint('Error detecting corners: $e');
      return false;
    }
  }

  bool _hasBlackBlob(img.Image image, int startX, int startY, int width, int height) {
    int blackPixelCount = 0;
    int totalPixels = width * height;
    
    for (int y = startY; y < startY + height && y < image.height; y++) {
      for (int x = startX; x < startX + width && x < image.width; x++) {
        var pixel = image.getPixel(x, y);
        int r = pixel.r.toInt();
        if (r < 128) blackPixelCount++;
      }
    }
    
    double ratio = blackPixelCount / totalPixels;
    return ratio > 0.05;
  }

  Future<void> _processImage(String imagePath) async {
    if (_isProcessing) return;
    
    setState(() {
      _isProcessing = true;
    });

    // Tampilkan loading
    if (mounted) {
      showDialog(
        context: context,
        barrierDismissible: false,
        builder: (context) => const Center(
          child: Card(
            child: Padding(
              padding: EdgeInsets.all(20),
              child: Column(
                mainAxisSize: MainAxisSize.min,
                children: [
                  CircularProgressIndicator(),
                  SizedBox(height: 16),
                  Text('‚úì 4 titik terdeteksi!\nMemproses...'),
                ],
              ),
            ),
          ),
        ),
      );
    }

    await Future.delayed(const Duration(milliseconds: 500));

    if (!mounted) return;
    Navigator.pop(context); // Tutup loading dialog

    // Navigate ke result screen
    Navigator.pushReplacement(
      context,
      MaterialPageRoute(
        builder: (context) => ResultScreen(
          imagePath: imagePath,
          dataSoal: widget.dataSoal,
        ),
      ),
    );
  }

  @override
  void dispose() {
    _detectionTimer?.cancel();
    _controller.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.black,
      appBar: AppBar(
        title: const Text("SCANNING"),
        backgroundColor: _cornersDetected ? Colors.green : Colors.orange,
        centerTitle: true,
        leading: IconButton(
          icon: const Icon(Icons.arrow_back),
          onPressed: () => Navigator.pop(context),
        ),
      ),
      body: FutureBuilder<void>(
        future: _initializeControllerFuture,
        builder: (context, snapshot) {
          if (snapshot.connectionState == ConnectionState.done) {
            return Stack(
              children: [
                // Camera Preview
                Center(
                  child: CameraPreview(_controller),
                ),
                
                // Overlay zona deteksi
                CustomPaint(
                  painter: ScannerOverlayPainter(
                    cornersDetected: _cornersDetected,
                  ),
                  child: Container(),
                ),
                
                // Status indicator
                Positioned(
                  top: 20,
                  left: 0,
                  right: 0,
                  child: Center(
                    child: Container(
                      padding: const EdgeInsets.symmetric(
                        horizontal: 20,
                        vertical: 12,
                      ),
                      decoration: BoxDecoration(
                        color: _cornersDetected 
                            ? Colors.green.withOpacity(0.9)
                            : Colors.orange.withOpacity(0.9),
                        borderRadius: BorderRadius.circular(20),
                      ),
                      child: Row(
                        mainAxisSize: MainAxisSize.min,
                        children: [
                          Icon(
                            _cornersDetected ? Icons.check_circle : Icons.search,
                            color: Colors.white,
                            size: 20,
                          ),
                          const SizedBox(width: 8),
                          Text(
                            _cornersDetected 
                                ? '‚úì 4 Titik Terdeteksi'
                                : 'Posisikan dalam zona hijau',
                            style: const TextStyle(
                              color: Colors.white,
                              fontWeight: FontWeight.bold,
                              fontSize: 14,
                            ),
                          ),
                        ],
                      ),
                    ),
                  ),
                ),
              ],
            );
          } else {
            return const Center(child: CircularProgressIndicator());
          }
        },
      ),
    );
  }
}

// Custom Painter untuk zona deteksi scanner
class ScannerOverlayPainter extends CustomPainter {
  final bool cornersDetected;

  ScannerOverlayPainter({this.cornersDetected = false});

  @override
  void paint(Canvas canvas, Size size) {
    // Margin zona deteksi
    final horizontalMargin = size.width * 0.08;
    final verticalMargin = size.height * 0.12;
    
    final lineLength = 50.0;
    final cornerRadius = 8.0;

    // Warna berubah saat terdeteksi
    final color = cornersDetected ? Colors.green : Colors.white;
    
    // Paint untuk garis sudut
    final linePaint = Paint()
      ..color = color
      ..style = PaintingStyle.stroke
      ..strokeWidth = 4;

    // Zona deteksi (kotak)
    final zoneRect = Rect.fromLTRB(
      horizontalMargin,
      verticalMargin,
      size.width - horizontalMargin,
      size.height - verticalMargin,
    );

    // Gambar garis sudut di 4 pojok
    // Top-Left
    canvas.drawLine(
      Offset(zoneRect.left, zoneRect.top + cornerRadius),
      Offset(zoneRect.left, zoneRect.top + lineLength),
      linePaint,
    );
    canvas.drawLine(
      Offset(zoneRect.left + cornerRadius, zoneRect.top),
      Offset(zoneRect.left + lineLength, zoneRect.top),
      linePaint,
    );

    // Top-Right
    canvas.drawLine(
      Offset(zoneRect.right, zoneRect.top + cornerRadius),
      Offset(zoneRect.right, zoneRect.top + lineLength),
      linePaint,
    );
    canvas.drawLine(
      Offset(zoneRect.right - cornerRadius, zoneRect.top),
      Offset(zoneRect.right - lineLength, zoneRect.top),
      linePaint,
    );

    // Bottom-Left
    canvas.drawLine(
      Offset(zoneRect.left, zoneRect.bottom - cornerRadius),
      Offset(zoneRect.left, zoneRect.bottom - lineLength),
      linePaint,
    );
    canvas.drawLine(
      Offset(zoneRect.left + cornerRadius, zoneRect.bottom),
      Offset(zoneRect.left + lineLength, zoneRect.bottom),
      linePaint,
    );

    // Bottom-Right
    canvas.drawLine(
      Offset(zoneRect.right, zoneRect.bottom - cornerRadius),
      Offset(zoneRect.right, zoneRect.bottom - lineLength),
      linePaint,
    );
    canvas.drawLine(
      Offset(zoneRect.right - cornerRadius, zoneRect.bottom),
      Offset(zoneRect.right - lineLength, zoneRect.bottom),
      linePaint,
    );

    // Kotak outline zona (opsional, bisa dihilangkan)
    final zonePaint = Paint()
      ..color = color.withOpacity(0.3)
      ..style = PaintingStyle.stroke
      ..strokeWidth = 2;
    
    canvas.drawRect(zoneRect, zonePaint);

    // Area gelap di luar zona
    final darkPaint = Paint()
      ..color = Colors.black.withOpacity(0.5);

    // Top
    canvas.drawRect(
      Rect.fromLTRB(0, 0, size.width, zoneRect.top),
      darkPaint,
    );
    // Bottom
    canvas.drawRect(
      Rect.fromLTRB(0, zoneRect.bottom, size.width, size.height),
      darkPaint,
    );
    // Left
    canvas.drawRect(
      Rect.fromLTRB(0, zoneRect.top, zoneRect.left, zoneRect.bottom),
      darkPaint,
    );
    // Right
    canvas.drawRect(
      Rect.fromLTRB(zoneRect.right, zoneRect.top, size.width, zoneRect.bottom),
      darkPaint,
    );

    // Teks petunjuk di bawah
    final textSpan = TextSpan(
      text: 'Posisikan 4 titik hitam di dalam zona',
      style: const TextStyle(
        color: Colors.white,
        fontSize: 16,
        fontWeight: FontWeight.bold,
      ),
    );
    
    final textPainter = TextPainter(
      text: textSpan,
      textAlign: TextAlign.center,
      textDirection: TextDirection.ltr,
    );
    
    textPainter.layout();
    
    final textBgRect = Rect.fromCenter(
      center: Offset(size.width / 2, zoneRect.bottom + 40),
      width: textPainter.width + 30,
      height: textPainter.height + 16,
    );
    
    canvas.drawRRect(
      RRect.fromRectAndRadius(textBgRect, const Radius.circular(10)),
      Paint()..color = Colors.black.withOpacity(0.75),
    );
    
    textPainter.paint(
      canvas,
      Offset(
        (size.width - textPainter.width) / 2,
        zoneRect.bottom + 32,
      ),
    );
  }

  @override
  bool shouldRepaint(ScannerOverlayPainter oldDelegate) {
    return oldDelegate.cornersDetected != cornersDetected;
  }
}import 'dart:io';
import 'dart:typed_data';
import 'package:flutter/material.dart';
import 'package:image/image.dart' as img;
import '../services/omr_processor.dart';

class ResultScreen extends StatefulWidget {
  final String imagePath;
  final Map<String, dynamic> dataSoal;

  const ResultScreen({
    super.key, 
    required this.imagePath, 
    required this.dataSoal
  });

  @override
  State<ResultScreen> createState() => _ResultScreenState();
}

class _ResultScreenState extends State<ResultScreen> {
  bool _isProcessing = true;
  Map<String, dynamic>? _hasilKoreksi;
  String? _errorMessage;

  @override
  void initState() {
    super.initState();
    _prosesGambar();
  }

  Future<void> _prosesGambar() async {
    try {
      // Load image
      File imageFile = File(widget.imagePath);
      Uint8List imageBytes = await imageFile.readAsBytes();
      img.Image? image = img.decodeImage(imageBytes);

      if (image == null) {
        throw Exception("Gagal decode image");
      }

      // Proses OMR
      OMRProcessor processor = OMRProcessor();
      Map<String, dynamic> hasil = await processor.prosesLJK(
        image, 
        widget.dataSoal['kunci_jawaban'] as List<String>,
        widget.dataSoal['jumlah_soal'] as int,
      );

      setState(() {
        _hasilKoreksi = hasil;
        _isProcessing = false;
      });

    } catch (e) {
      setState(() {
        _errorMessage = e.toString();
        _isProcessing = false;
      });
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: const Text("Hasil Koreksi")),
      body: _isProcessing
          ? const Center(
              child: Column(
                mainAxisAlignment: MainAxisAlignment.center,
                children: [
                  CircularProgressIndicator(),
                  SizedBox(height: 20),
                  Text("Memproses LJK..."),
                ],
              ),
            )
          : _errorMessage != null
              ? Center(
                  child: Padding(
                    padding: const EdgeInsets.all(20),
                    child: Column(
                      mainAxisAlignment: MainAxisAlignment.center,
                      children: [
                        const Icon(Icons.error, size: 80, color: Colors.red),
                        const SizedBox(height: 20),
                        Text("Error: $_errorMessage"),
                        const SizedBox(height: 20),
                        ElevatedButton(
                          onPressed: () => Navigator.pop(context),
                          child: const Text("Coba Lagi"),
                        ),
                      ],
                    ),
                  ),
                )
              : _buildHasilView(),
    );
  }

  Widget _buildHasilView() {
    int benar = _hasilKoreksi!['benar'];
    int salah = _hasilKoreksi!['salah'];
    int total = _hasilKoreksi!['total'];
    double nilai = (benar / total) * 100;
    List<Map<String, dynamic>> detail = _hasilKoreksi!['detail'];

    return SingleChildScrollView(
      padding: const EdgeInsets.all(16),
      child: Column(
        children: [
          // Kartu Nilai
          Card(
            color: nilai >= 75 ? Colors.green[50] : Colors.red[50],
            child: Padding(
              padding: const EdgeInsets.all(20),
              child: Column(
                children: [
                  Text("NILAI", style: TextStyle(fontSize: 16, color: Colors.grey[700])),
                  const SizedBox(height: 10),
                  Text(
                    nilai.toStringAsFixed(1), 
                    style: TextStyle(
                      fontSize: 60, 
                      fontWeight: FontWeight.bold,
                      color: nilai >= 75 ? Colors.green : Colors.red,
                    )
                  ),
                  const SizedBox(height: 10),
                  Row(
                    mainAxisAlignment: MainAxisAlignment.spaceEvenly,
                    children: [
                      _buildStat("Benar", benar, Colors.green),
                      _buildStat("Salah", salah, Colors.red),
                      _buildStat("Total", total, Colors.blue),
                    ],
                  ),
                ],
              ),
            ),
          ),

          const SizedBox(height: 20),
          const Text("Detail Jawaban:", style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold)),
          const SizedBox(height: 10),

          // Tabel Detail
          ...detail.map((item) {
            int nomor = item['nomor'];
            String kunci = item['kunci'];
            String jawaban = item['jawaban'];
            bool benar = item['benar'];

            return Card(
              margin: const EdgeInsets.only(bottom: 8),
              color: benar ? Colors.green[50] : Colors.red[50],
              child: ListTile(
                leading: CircleAvatar(
                  backgroundColor: benar ? Colors.green : Colors.red,
                  child: Text("$nomor", style: const TextStyle(color: Colors.white)),
                ),
                title: Text("Jawaban: $jawaban"),
                subtitle: Text("Kunci: $kunci"),
                trailing: Icon(
                  benar ? Icons.check_circle : Icons.cancel,
                  color: benar ? Colors.green : Colors.red,
                ),
              ),
            );
          }),
        ],
      ),
    );
  }

  Widget _buildStat(String label, int value, Color color) {
    return Column(
      children: [
        Text(label, style: TextStyle(color: Colors.grey[600])),
        const SizedBox(height: 5),
        Text("$value", style: TextStyle(fontSize: 24, fontWeight: FontWeight.bold, color: color)),
      ],
    );
  }
}import 'package:flutter/material.dart';
import 'package:firebase_auth/firebase_auth.dart';
import 'create_exam_screen.dart';
import 'scanner_screen.dart';
import 'exam_list_screen.dart';
import '../services/auth_service.dart';
import '../services/migration_helper.dart'; // Import migration helper
import 'auth/login_screen.dart';

class HomeScreen extends StatefulWidget {
  const HomeScreen({super.key});

  @override
  State<HomeScreen> createState() => _HomeScreenState();
}

class _HomeScreenState extends State<HomeScreen> {
  bool _isMigrating = false;

  @override
  void initState() {
    super.initState();
    _checkAndMigrate();
  }

  // Cek dan migrasi data lama jika ada
  Future<void> _checkAndMigrate() async {
    setState(() => _isMigrating = true);
    
    try {
      final migrationHelper = MigrationHelper();
      
      // Cek struktur data
      await migrationHelper.checkDataStructure();
      
      // Migrasi data lama jika ada
      await migrationHelper.migrateOldDataToUser();
      
    } catch (e) {
      print('Error saat migrasi: $e');
    } finally {
      if (mounted) {
        setState(() => _isMigrating = false);
      }
    }
  }

  Future<void> _logout(BuildContext context) async {
    final shouldLogout = await showDialog<bool>(
      context: context,
      builder: (context) => AlertDialog(
        title: const Text('Logout'),
        content: const Text('Apakah Anda yakin ingin keluar?'),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context, false),
            child: const Text('Batal'),
          ),
          TextButton(
            onPressed: () => Navigator.pop(context, true),
            style: TextButton.styleFrom(foregroundColor: Colors.red),
            child: const Text('Logout'),
          ),
        ],
      ),
    );

    if (shouldLogout == true && context.mounted) {
      try {
        await AuthService().signOut();
        
        if (context.mounted) {
          Navigator.of(context).pushAndRemoveUntil(
            MaterialPageRoute(builder: (_) => const LoginScreen()),
            (route) => false,
          );
        }
      } catch (e) {
        if (context.mounted) {
          ScaffoldMessenger.of(context).showSnackBar(
            SnackBar(
              content: Text('Error: ${e.toString()}'),
              backgroundColor: Colors.red,
            ),
          );
        }
      }
    }
  }

  String _getInitial(User? user) {
    if (user == null) return 'U';
    
    if (user.displayName != null && user.displayName!.isNotEmpty) {
      return user.displayName!.substring(0, 1).toUpperCase();
    }
    
    if (user.email != null && user.email!.isNotEmpty) {
      return user.email!.substring(0, 1).toUpperCase();
    }
    
    return 'U';
  }

  String _getDisplayName(User? user) {
    if (user == null) return 'User';
    
    if (user.displayName != null && user.displayName!.isNotEmpty) {
      return user.displayName!;
    }
    
    if (user.email != null && user.email!.isNotEmpty) {
      return user.email!.split('@')[0];
    }
    
    return 'User';
  }

  @override
  Widget build(BuildContext context) {
    final user = FirebaseAuth.instance.currentUser;

    // Tampilkan loading saat migrasi
    if (_isMigrating) {
      return Scaffold(
        body: Center(
          child: Column(
            mainAxisAlignment: MainAxisAlignment.center,
            children: [
              CircularProgressIndicator(),
              SizedBox(height: 16),
              Text(
                'Menyiapkan data...',
                style: TextStyle(fontSize: 16),
              ),
            ],
          ),
        ),
      );
    }

    return Scaffold(
      appBar: AppBar(
        title: const Text("Aplikasi Koreksi Ujian"),
        centerTitle: true,
        elevation: 2,
        actions: [
          IconButton(
            icon: const Icon(Icons.logout),
            tooltip: 'Logout',
            onPressed: () => _logout(context),
          ),
        ],
      ),
      body: Center(
        child: Padding(
          padding: const EdgeInsets.all(20.0),
          child: Column(
            mainAxisAlignment: MainAxisAlignment.center,
            children: [
              // Info User
              Container(
                padding: const EdgeInsets.all(16),
                decoration: BoxDecoration(
                  color: Colors.blue.shade50,
                  borderRadius: BorderRadius.circular(12),
                ),
                child: Row(
                  children: [
                    CircleAvatar(
                      backgroundColor: Colors.blue,
                      child: Text(
                        _getInitial(user),
                        style: const TextStyle(
                          color: Colors.white,
                          fontWeight: FontWeight.bold,
                        ),
                      ),
                    ),
                    const SizedBox(width: 12),
                    Expanded(
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          Text(
                            _getDisplayName(user),
                            style: const TextStyle(
                              fontWeight: FontWeight.bold,
                              fontSize: 16,
                            ),
                          ),
                          Text(
                            user?.email ?? '',
                            style: TextStyle(
                              color: Colors.grey[600],
                              fontSize: 12,
                            ),
                          ),
                        ],
                      ),
                    ),
                  ],
                ),
              ),
              const SizedBox(height: 30),

              const Text(
                "Menu Guru",
                style: TextStyle(
                  fontSize: 18,
                  fontWeight: FontWeight.bold,
                  color: Colors.blueGrey,
                ),
              ),
              const Divider(),
              const SizedBox(height: 10),

              _tombolMenu(
                context,
                "Buat Kunci Jawaban",
                Icons.edit_note,
                Colors.blue,
                const CreateExamScreen(),
              ),

              const SizedBox(height: 15),

              _tombolMenu(
                context,
                "Bank Soal & Download PDF",
                Icons.file_download,
                Colors.orange,
                const ExamListScreen(),
              ),

              const SizedBox(height: 40),

              const Text(
                "Menu Koreksi",
                style: TextStyle(
                  fontSize: 18,
                  fontWeight: FontWeight.bold,
                  color: Colors.blueGrey,
                ),
              ),
              const Divider(),
              const SizedBox(height: 10),

              _tombolMenu(
                context,
                "Mulai Scan LJK",
                Icons.qr_code_scanner,
                Colors.green,
                const ScannerPage(),
              ),
            ],
          ),
        ),
      ),
    );
  }

  Widget _tombolMenu(
    BuildContext context,
    String text,
    IconData icon,
    Color color,
    Widget page,
  ) {
    return SizedBox(
      width: double.infinity,
      height: 55,
      child: ElevatedButton.icon(
        icon: Icon(icon, color: Colors.white),
        label: Text(
          text,
          style: const TextStyle(fontSize: 16, fontWeight: FontWeight.bold),
        ),
        style: ElevatedButton.styleFrom(
          backgroundColor: color,
          foregroundColor: Colors.white,
          shape: RoundedRectangleBorder(
            borderRadius: BorderRadius.circular(10),
          ),
        ),
        onPressed: () {
          Navigator.push(context, MaterialPageRoute(builder: (_) => page));
        },
      ),
    );
  }
}import 'package:flutter/material.dart';
import '../services/firebase_service.dart';
import '../services/pdf_generator.dart';

class ExamListScreen extends StatefulWidget {
  const ExamListScreen({super.key});

  @override
  State<ExamListScreen> createState() => _ExamListScreenState();
}

class _ExamListScreenState extends State<ExamListScreen> {
  List<Map<String, dynamic>> _listSoal = [];
  bool _isLoading = true;

  @override
  void initState() {
    super.initState();
    _loadSoal();
  }

  Future<void> _loadSoal() async {
    setState(() => _isLoading = true);
    _listSoal = await FirebaseService().getAllSoal();
    setState(() => _isLoading = false);
  }

  Future<void> _downloadPDF(Map<String, dynamic> soal) async {
    showDialog(
      context: context,
      barrierDismissible: false,
      builder: (context) => const Center(
        child: CircularProgressIndicator(),
      ),
    );

    try {
      // Fixed: Use proper instance of PDFGenerator
      final pdfGenerator = PDFGenerator();
      await pdfGenerator.generateAndPrint(
        kodeSoal: soal['kode_soal'],
        namaSoal: soal['nama_soal'],
        jumlahSoal: soal['jumlah_soal'],
      );
      
      if (!mounted) return;
      Navigator.pop(context);
      
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(
          content: Text('‚úÖ PDF Lembar Jawaban siap dicetak!'),
          backgroundColor: Colors.green,
        ),
      );
    } catch (e) {
      if (!mounted) return;
      Navigator.pop(context);
      
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text('‚ùå Error: $e'),
          backgroundColor: Colors.red,
        ),
      );
    }
  }

  Future<void> _hapusSoal(String kodeSoal) async {
    final confirm = await showDialog<bool>(
      context: context,
      builder: (context) => AlertDialog(
        title: const Text('Konfirmasi Hapus'),
        content: Text('Hapus soal "$kodeSoal"?'),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context, false),
            child: const Text('Batal'),
          ),
          ElevatedButton(
            onPressed: () => Navigator.pop(context, true),
            style: ElevatedButton.styleFrom(backgroundColor: Colors.red),
            child: const Text('Hapus'),
          ),
        ],
      ),
    );

    if (confirm == true) {
      bool sukses = await FirebaseService().hapusSoal(kodeSoal);
      if (sukses) {
        _loadSoal();
        if (!mounted) return;
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(content: Text('‚úÖ Soal berhasil dihapus')),
        );
      }
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: const Text('Bank Soal'),
        actions: [
          IconButton(
            icon: const Icon(Icons.refresh),
            onPressed: _loadSoal,
          ),
        ],
      ),
      body: _isLoading
          ? const Center(child: CircularProgressIndicator())
          : _listSoal.isEmpty
              ? const Center(
                  child: Text(
                    'Belum ada soal.\nBuat soal baru terlebih dahulu.',
                    textAlign: TextAlign.center,
                    style: TextStyle(fontSize: 16, color: Colors.grey),
                  ),
                )
              : ListView.builder(
                  padding: const EdgeInsets.all(16),
                  itemCount: _listSoal.length,
                  itemBuilder: (context, index) {
                    final soal = _listSoal[index];
                    return Card(
                      margin: const EdgeInsets.only(bottom: 12),
                      child: ListTile(
                        leading: CircleAvatar(
                          backgroundColor: Colors.blue,
                          child: Text(
                            soal['kode_soal'].substring(0, 1),
                            style: const TextStyle(color: Colors.white, fontWeight: FontWeight.bold),
                          ),
                        ),
                        title: Text(
                          soal['kode_soal'],
                          style: const TextStyle(fontWeight: FontWeight.bold),
                        ),
                        subtitle: Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            Text(soal['nama_soal']),
                            const SizedBox(height: 4),
                            Text(
                              '${soal['jumlah_soal']} Soal',
                              style: const TextStyle(fontSize: 12, color: Colors.grey),
                            ),
                          ],
                        ),
                        trailing: Row(
                          mainAxisSize: MainAxisSize.min,
                          children: [
                            // TOMBOL DOWNLOAD PDF
                            IconButton(
                              icon: const Icon(Icons.print, color: Colors.green),
                              onPressed: () => _downloadPDF(soal),
                              tooltip: 'Cetak Lembar Jawaban',
                            ),
                            // TOMBOL HAPUS
                            IconButton(
                              icon: const Icon(Icons.delete, color: Colors.red),
                              onPressed: () => _hapusSoal(soal['kode_soal']),
                              tooltip: 'Hapus Soal',
                            ),
                          ],
                        ),
                      ),
                    );
                  },
                ),
    );
  }
}
        // Sudah login
        if (snapshot.hasData && snapshot.data != null) {
          print('‚úì User aktif: ${snapshot.data?.email}');
          return const HomeScreen();
        }

        // Belum login
        print('‚úó Tidak ada user, ke LoginScreen');
        return const LoginScreen();
      },
    );
  }
}
